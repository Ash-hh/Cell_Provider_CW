<!DOCTYPE html>
<html>
    <head>
        <style>
       
           

            #popup, #awaitPopUp{
                width:100%;
                min-height:100%;
                background-color: rgba(0,0,0,0.5);
                overflow:hidden;
                position:fixed;
                visibility: hidden;
                top:0px;
                
            }
            #popup #popup_content{
                margin:40px auto 0px auto;
                width:420px;
                height: 90px;
                padding:10px;
                background-color: #c5c5c5;
                border-radius:5px;
                box-shadow: 0px 0px 10px #000;
            }       
        </style>
    </head>
    <body>
        <script>
                
            let arr=[];     
                
            function send(Button_Value){

                if(Button_Value.indexOf('Xml')==-1){
                    fetch(`http://localhost:5000/api/all/${Button_Value}`)
                    .then(result=>{
                        return result.json()
                    }).then(data=>{

                        arr = data;

                        switch(Button_Value){
                            case 'AllUsers' : UsersInterface(arr); break;
                            case 'AllTariffs' : TariffInterface(arr); break;
                            case 'AllNumbers' : NumberInterface(arr); break;
                            case 'AllCalls' : CallInterface(arr); break;
                        }
                        
                    })
                } else {
                    console.log(Button_Value)
                    awaitPopUp.style.visibility = 'visible';

                    fetch(`http://localhost:5000/api/admin/${Button_Value}/0`)
                    .then(result =>{
                        return result.text()
                    }).then(data=>{
                        awaitPopUp.style.visibility = 'hidden';
                        alert(data);
                        
                    })
                }
            }

            function ControllerFunc(id,name,value,Tariff=undefined){

               

                value = JSON.parse(value)
                
                let searchelem = arr.find(user => user[name] == id);
                
                let elemId =  arr.indexOf(searchelem); //TODO:refactor

                if(value.exec.indexOf('Delete')==-1){
                    if(!Tariff && value.exec.indexOf('Update')!=-1){
                        if(value.property === 'User_Type'){
                            searchelem[value.property] = searchelem[value.property] == 1 ? 2 : 1;
                        } else{
                            searchelem[value.property] = !searchelem[value.property]
                        }
                    } else {
                        searchelem = Tariff ? Tariff : searchelem;
                        arr[elemId] = searchelem; 
                    }   
                } else {
                    if(confirm('U cant rollbcak Delete')){
                        arr.splice(elemId,1);
                                              
                    } else {
                       
                        return 0;
                    }
                }

             
                
                fetch(`http://localhost:5000/api/admin/${value.exec}/${id}`,{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(searchelem)
                })
                .then(result=>{
                    if(result.ok)
                        return result.text();
                }).then(data=>{
                    if(value.exec.indexOf('Tariff')!=-1 && value.exec == 'AddTariff') 
                    {   
                        send('AllTariffs')
                    } else {    
                        TariffInterface(arr)
                    }                
                    if(value.exec.indexOf('Number')!=-1) {NumberInterface(arr)}
                    if(value.exec.indexOf('User')!=-1) {UsersInterface(arr)}
                    if(value.exec.indexOf('Call')!=-1) {CallInterface(arr)}

                })

            }
            
            function UsersInterface(usersArr){

                let UserTable = document.createElement("table")
                
                let tableHeader = UserTable.insertRow();

                tableHeader.insertCell().innerHTML = 'Id'
                tableHeader.insertCell().innerHTML = 'Login'
                tableHeader.insertCell().innerHTML = 'Name'
                tableHeader.insertCell().innerHTML = 'Surname'
                tableHeader.insertCell().innerHTML = 'Second Name'
                tableHeader.insertCell().innerHTML = 'Type'
                tableHeader.insertCell().innerHTML = 'Ballance'
                tableHeader.insertCell().innerHTML = 'Status'

                usersArr.forEach(element => {
                    let row = UserTable.insertRow()
                        row.insertCell().append(element.User_Id)
                        row.insertCell().append(element.Login)
                        row.insertCell().append(element.User_Name)
                        row.insertCell().append(element.User_Surname)
                        row.insertCell().append(element.User_MidName)
                        row.insertCell().append(element.User_Type == 1 ? 'Admin' : 'User')
                        row.insertCell().append(element.Ballance)
                        row.insertCell().append(element.IsActive ? 'Active' : 'Not Active')
                        
                        let userController = row.insertCell().innerHTML = ` 
                        <button 
                            id="${element.User_Id}" 
                            name="User_Id" 
                            value='{"exec":"UpdateUser","property":"IsActive"}' 
                            onclick="ControllerFunc(this.id, this.name, this.value)">
                        ${element.IsActive ? 'Disactivate' : 'Activate' } </button>
                       
                        <button 
                            id="${element.User_Id}" 
                            name="User_Id" 
                            value='{"exec":"UpdateUser","property":"User_Type"}' 
                            onclick="ControllerFunc(this.id,this.name, this.value)">
                        ${element.User_Type == 1 ? 'Revoke Admin':'Grant Admin'} </button>    
                       
                        <button 
                            id="${element.User_Id}" 
                            name="DeleteUser" 
                            value='{"exec":"DeleteUser"}' 
                            onclick="ControllerFunc(this.id,this.name, this.value)">
                        Delete User </button>`;
                });
                resultDiv.innerHTML='';
                resultDiv.append(UserTable);
            } 

            function TariffInterface(tariffArr){
                let TariffTable = document.createElement("table")
                
                let tableHeader = TariffTable.insertRow();

                tableHeader.insertCell().innerHTML = 'Id'
                tableHeader.insertCell().innerHTML = 'Description'
                tableHeader.insertCell().innerHTML = 'Call Cost Per Min'

                tariffArr.forEach(element => {
                    let row = TariffTable.insertRow()
                        row.insertCell().append(element.Tariff_Id)
                        row.insertCell().append(element.Description)
                        row.insertCell().append(element.Call_Cost_perm)
                        
                        let tariffController = row.insertCell().innerHTML = ` 
                        <button 
                            id="${element.Tariff_Id}" 
                            name="TariffDelete" 
                            value='{"exec":"DeleteTariff"}' 
                            onclick="ControllerFunc(this.id, this.name, this.value)">
                        Delete </button>    

                        <button 
                            id="${element.Tariff_Id}" 
                            name="Tariff_Id" 
                            onclick="PopUpShow('Edit',this.id,this.name)">
                        Edit </button>    `;
                });

                resultDiv.innerHTML='';
                resultDiv.append(TariffTable);
            }

            function NumberInterface(numberArr){
                let NumberTable = document.createElement("table")
                
                let tableHeader = NumberTable.insertRow();

                tableHeader.insertCell().innerHTML = 'Id'
                tableHeader.insertCell().innerHTML = 'Number'
                tableHeader.insertCell().innerHTML = 'User Id'
                tableHeader.insertCell().innerHTML = 'Tariff Id'
                tableHeader.insertCell().innerHTML = 'Open Date'
                tableHeader.insertCell().innerHTML = 'Activity'
                tableHeader.insertCell().innerHTML = 'Ballance'

                numberArr.forEach(element => {
                    let row = NumberTable.insertRow()
                        row.insertCell().append(element.Number_Id)
                        row.insertCell().append(element.Number)
                        row.insertCell().append(element.User_Id)
                        row.insertCell().append(element.Tariff_Id)
                        row.insertCell().append(element.Date_Open)
                        row.insertCell().append(element.IsActive == 1 ? 'Active' : 'Not Active')
                        row.insertCell().append(element.Ballance)                        
                        
                        let numberController = row.insertCell().innerHTML = ` 
                        <button 
                            id="${element.Number_Id}" 
                            name="Number_Id" 
                            value='{"exec":"UpdateNumber","property":"IsActive"}' 
                            onclick="ControllerFunc(this.id, this.name, this.value)">
                        ${element.IsActive ? 'Disactivate' : 'Activate' } </button>
                       
                        <button 
                            id="${element.Number_Id}" 
                            name="Number_Id" 
                            value='{"exec":"DeleteNumber"}' 
                            onclick="ControllerFunc(this.id,this.name, this.value)">
                        Delete </button>`
                });

                resultDiv.innerHTML='';
                resultDiv.append(NumberTable);
            }

            function CallInterface(callArr){

                let CallTable = document.createElement("table")
                
                let tableHeader = CallTable.insertRow();

                tableHeader.insertCell().innerHTML = 'Id'
                tableHeader.insertCell().innerHTML = 'Sender'
                tableHeader.insertCell().innerHTML = 'Receiver'

                callArr.forEach(element => {
                    let row = CallTable.insertRow()
                        row.insertCell().append(element.Call_Id)
                        row.insertCell().append(element.User_Sender_Id)
                        row.insertCell().append(element.User_Receiver_Id)
                        
                        let callController = row.insertCell().innerHTML = ` 
                        <button 
                            id="${element.Call_Id}" 
                            name="Call_Id" 
                            value='{"exec":"DeleteCall"}' 
                            onclick="ControllerFunc(this.id, this.name, this.value)">
                        Delete </button>`
                });

                resultDiv.innerHTML='';
                resultDiv.append(CallTable);
            }

            function PopUpHide(){
                popup.style.visibility = "hidden";               
            }

            function PopUpShow(mode,id,name){

                let searchelem = arr.find(user => user[name] == id);

                if(mode === 'Edit'){

                    popup_content.innerHTML = `
                    <input type='button' value='close' onclick='PopUpHide()'>
                    <form name="TariffForm">
                        <label name="id" id="${id}">Edit Tariff Id: ${id}</label>
                        <br>
                        <input type="text" name="Description" value="${searchelem.Description}">
                        <br>
                        <input type="text" name ="Call_Cost" value="${searchelem.Call_Cost_perm}">
                        <br>
                        <input type="button" value="Edit" onclick="TariffEdit(${id})">
                    </form>`

                } else if (mode === 'Delete'){
                    
                    popup_content.innerHTML =`
                    <input type='button' value='close' onclick='PopUpHide()'>
                    <form name="TariffFormAdd">
                        <label> Description </label>
                        <input type="text" name="Description">
                        <br>
                        <label> Call Cost </label>
                        <input type="text" name ="Call_Cost" >
                        <br>
                        <input type="button" value="Add" onclick="AddTariff()">
                    </form>`
                }

                popup.style.visibility = "visible" 
            }

            function TariffEdit(id){
                let form = document.forms.TariffForm;

                let Tariff = {
                    Tariff_Id :id,
                    Description : form.Description.value,
                    Call_Cost_perm : form.Call_Cost.value
                }
                ControllerFunc(id,"Tariff_Id",'{"exec":"UpdateTariff"}',Tariff)

                PopUpHide();
            }
            
            function AddTariff(){
                let form = document.forms.TariffFormAdd;

                let Tariff = {
                    Description : form.Description.value,
                    Call_Cost_perm : form.Call_Cost.value
                }
               
                ControllerFunc(undefined,"Tariff_Id",'{"exec":"AddTariff"}',Tariff) //TODO: refactor
                PopUpHide();
                
            }

        </script>

        <div id="awaitPopUp">
            <h1>This operation may take a few minutes...</h1>
        </div>
        <div id="popup">
            <div id="popup_content">
               
            </div>
        </div>
        <div>
            <input type='button' name="AllUsers" value="AllUsers" onclick="send(this.name)">
            <input type='button' name="AllTariffs" value="AllTariffs" onclick="send(this.name)">
            <input type='button' name="AllNumbers" value="AllNumbers" onclick="send(this.name)">
            <input type='button' name="AllCalls" value="AllCalls" onclick="send(this.name)">
            <input type='button' name="AddTariff"value="AddTariff" onclick="PopUpShow('Delete')">            
            <input type='button' name="ExportAllToXml"value="ExportAllToXml" onclick="send(this.name)">              
            <input type='button' name="ImportFromXml"value="ImportFromXml" onclick="send(this.name)">
                
            </select>
        </div>
        <hr>
        <div id='resultDiv'>

        </div>
    </body>

</html>