<!DOCTYPE html>
<html>
    <style>
        #popup{
             width:100%;
             min-height:100%;
             background-color: rgba(0,0,0,0.5);
             overflow:hidden;
             position:fixed;
             top:0px;
             visibility: hidden;
             
         }
         #popup #popup_content{
             margin:40px auto 0px auto;
             width:420px;
             height: 90px;
             padding:10px;
             background-color: #c5c5c5;
             border-radius:5px;
             box-shadow: 0px 0px 10px #000;
         }       
    </style>
    <script>
        let globalValue;

        function PopUpHide(){
            popup.style.visibility = "hidden";               
        }
        
        function PopUpShow(){
            popup.style.visibility = "visible" 
        }

        function BallanceUpdate(value){

            PopUpShow();


            //TODO:

            globalValue = value;

            BallanceUpdateButton.onclick = (event) =>{
               
                globalValue.ballance=parseInt(globalValue.ballance)+parseInt(ballancevalue.value)
               
                PopUpHide();
                profileController(globalValue);

                BallanceValue.innerHTML=`Ballance: ${globalValue.ballance}`


            }
        }       

        function profileController(value){ 
           
            
            let postBody;

            switch(value.name){

                case 'UserBallance':
                    postBody= {
                        id:value.id,
                        userObj:{Ballance:value.ballance}
                    }


                break;

                case 'UserDelete':
                    if(confirm('??')){
                        postBody= {
                            id:value.id,
                            userObj:{IsActive:false}
                        } 
                    }
                break;

                case 'NumberDelete':
                    postBody={
                        id:value.id,                       
                    }
                break;
                default:return 0;
            }   


           
            
            fetch('http://localhost:5000/api/user',{
                method:'POST',                   
                headers:{'Content-Type':'application/json'},
               
                body:JSON.stringify(postBody)                
            }).then(result=>{
                if(result.redirected){
                 
                   window.location.href = result.url                   
                   
                } else if(result.ok){
                    return  result.json();
                }
            }).then(data=>{
                if(value.name === 'NumberDelete'){
                    UserInfo(data);
                    
                }
            })

            
        }
     
        function UserInfo(data){
           
            NumbersInfo.innerHTML = '';

            ProfileInfo.innerHTML = `
                <div>
                    <h3>Profile Information </h3>
                    <p>${data.User.User_Type = 1 ? 'Admin' : 'User'} login: ${data.User.Login} </p>
                    <p>Name: ${data.User.User_Name} ${data.User.User_Surname} ${data.User.User_MidName}</p>
                    <p>Status: ${data.User.IsActive ? 'Active' : 'Not Active'} </p>
                </div> 
            `

            if(data.IsLogin){
                AuthorizedUserInfo(data);
            }
        }
        
        function AuthorizedUserInfo(data){
            ProfileInfo.innerHTML += `
                <p><span id='BallanceValue'>Ballance: ${data.User.Ballance}</span>
                    <button
                        name="UserBallance"
                        value='${data.User.User_Id}'
                        onclick="BallanceUpdate({id:this.value,name:this.name,ballance:${data.User.Ballance}})">
                    Top up</button> 
                </p>
                <button
                    name="UserDelete"
                    value='${data.User.User_Id}'
                    onclick="profileController({id:this.value,name:this.name})">
                Delete My Account </button>    
                <hr>
            `

            if(data.hasOwnProperty('Numbers')){

                let NumsTable = document.createElement("table");

                let tableHeader = NumsTable.insertRow();
                tableHeader.insertCell().innerHTML='Number'
                tableHeader.insertCell().innerHTML='Tariff'
                tableHeader.insertCell().innerHTML='Call Cost'
                tableHeader.insertCell().innerHTML='Date open'

                   

                if(data.Numbers.length >1){
                    data.Numbers.forEach(element => {
                        let row = NumsTable.insertRow();

                        row.insertCell().append(element.Number)
                        row.insertCell().append(element.Description)
                        row.insertCell().append(element.Call_Cost_perm)
                        row.insertCell().append(element.Date_Open)

                        row.insertCell().innerHTML =`
                            <button
                                id="${element.Number_Id}"
                                name="DeleteNumber"
                                onclick="profileController({id:this.id,name:'NumberDelete'})">
                            Delete Number</button>
                        `
                    })  
                } else {
                    let row = NumsTable.insertRow();

                    row.insertCell().append(data.Numbers.Number)
                    row.insertCell().append(data.Numbers.Description)
                    row.insertCell().append(data.Numbers.Call_Cost_perm)
                    row.insertCell().append(data.Numbers.Date_Open)
                    row.insertCell().innerHTML =`
                        <button
                            id="${data.Numbers.Number_Id}"
                            name="DeleteNumber"
                            onclick="profileController({id:this.id,name:'NumberDelete'})">
                        Delete Number</button>
                    `
                }
            
                NumbersInfo.append(NumsTable)
            }
        }

        function load(){  
            
            let urlstr = 'http://localhost:5000/';

            let login = document.URL
            .slice(document.URL
            .indexOf('/profile')+'/profile'.length+1,
                    document.URL.length) 
           
            fetch(`${document.URL}`,{
                method:'POST', mode:'no-cors'
            })
            .then(result=>{                
                return result.json();
            })
            .then((data)=>{           
              
                
                UserInfo(data);
                
            })
        }
    </script>
    <body onload="load()">
        <header>
            <a href='http://localhost:5000/'>Main</a>
            <a href='http://localhost:5000/Call'>Call</a>
            <a href='http://localhost:5000/logout'>Log Out</a>
        </header>

        <div id="popup">
            <div id="popup_content">
                <input type="number" id="ballancevalue">
                <button id="BallanceUpdateButton" >Top Up</button>
            </div>
        </div>

        <div id='ProfileInfo'>

        </div>
        <div id='NumbersInfo'>
            
        </div>
    </body>
</html>